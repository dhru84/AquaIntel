<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Fish Abundance Density – Arabian Sea (World Map • Realistic)</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css"/>
  <style>
    :root{
      --panel-bg: rgba(255,255,255,0.94);
      --panel-text: #0f172a;
      --muted: #475569;
      --shadow: 0 8px 24px rgba(0,0,0,.25);
    }
    *{margin:0;padding:0;box-sizing:border-box}
    html,body{height:100%;background:#eaeff5;font-family:ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Arial}
    #map{width:100%;height:100%}
    .legend,.forecast-banner,.controls,.view-controls button{
      background:var(--panel-bg); color:var(--panel-text); border:1px solid rgba(0,0,0,.06);
      border-radius:10px; box-shadow:var(--shadow); backdrop-filter: blur(4px);
    }
    .legend{padding:14px;line-height:22px;font-size:13px}
    .legend h4{margin:0 0 8px;font-size:13px;color:#0f172a;font-weight:700}
    .legend-item{display:flex;align-items:center;margin:6px 0}
    .legend-color{width:26px;height:16px;margin-right:10px;border:1px solid rgba(0,0,0,.12)}
    .forecast-banner{position:absolute;bottom:20px;left:20px;padding:14px 16px;z-index:1000;font-size:13px;max-width:440px}
    .forecast-banner h3{margin:0 0 6px;font-size:15px}
    .forecast-banner p{margin:2px 0;color:var(--muted)}
    .controls{position:absolute;top:20px;right:20px;padding:14px 16px;z-index:1000;min-width:300px}
    .controls h4{margin:0 0 10px;font-size:13px}
    .slider-container{margin:10px 0}
    .slider-container label{display:block;margin-bottom:6px;font-size:12px;font-weight:700}
    #timeSlider{width:100%;margin-bottom:6px}
    #dateDisplay{text-align:center;font-size:12px;color:var(--muted);margin-bottom:10px}
    .button-group{display:flex;gap:10px}
    button{flex:1;padding:8px 12px;background:#0ea5e9;color:#001018;border:none;border-radius:8px;cursor:pointer;
      font-size:13px;font-weight:800;letter-spacing:.2px}
    button:hover{background:#0284c7}
    button:disabled{background:#cbd5e1;color:#64748b;cursor:not-allowed}
    .leaflet-popup-content{font-size:13px;line-height:1.6}
    .leaflet-popup-content h3{margin:0 0 8px;font-size:14px}
    .popup-row{margin:5px 0}
    .popup-label{font-weight:bold}
    .contour-label{background:rgba(14,165,233,.85);border:none;font-weight:bold;font-size:11px;padding:2px 4px;color:#001018;border-radius:4px}
    .view-controls{position:absolute;top:20px;left:20px;z-index:1000;display:flex;gap:8px}
    .view-controls button{padding:8px 10px}
    .leaflet-control-layers{font-size:12px}
    .leaflet-control-attribution{background:rgba(255,255,255,.85);border-radius:6px}
  </style>
</head>
<body>
  <div id="map"></div>

  <div class="view-controls">
    <button id="btnArabian">Zoom to Arabian Sea</button>
    <button id="btnWorld">World view</button>
  </div>

  <div class="forecast-banner">
    <h3>Fish Abundance Density</h3>
    <p><strong>Forecast Date:</strong> <span id="bannerForecastDate"></span></p>
    <p><strong>Issued on:</strong> <span id="bannerIssueDate"></span></p>
  </div>

  <div class="controls">
    <h4>Time Controls</h4>
    <div class="slider-container">
      <label>Select Day:</label>
      <input type="range" id="timeSlider" min="0" max="6" value="0" step="1">
      <div id="dateDisplay"></div>
    </div>
    <div class="button-group">
      <button id="playBtn">Play</button>
      <button id="pauseBtn" disabled>Pause</button>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
  <script>
    // ====== MAP (world-ready, realistic imagery) ======
    const map = L.map('map', {
      center: [20, 0],
      zoom: 2,
      zoomControl: true,
      worldCopyJump: true
    });

    // Esri World Imagery (default for realistic look)
    const esriImg = L.tileLayer(
      'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
      { attribution: 'Tiles &copy; Esri — Maxar, Earthstar, GeoEye, USDA, USGS', maxZoom: 18 }
    ).addTo(map);

    // Optional: Ocean basemap for bathymetry context & labels
    const esriOcean = L.tileLayer(
      'https://server.arcgisonline.com/ArcGIS/rest/services/Ocean/World_Ocean_Base/MapServer/tile/{z}/{y}/{x}',
      { attribution: 'Tiles &copy; Esri — Ocean/GEBCO, NOAA, National Geographic', maxZoom: 13 }
    );
    const oceanRef = L.tileLayer(
      'https://server.arcgisonline.com/ArcGIS/rest/services/Ocean/World_Ocean_Reference/MapServer/tile/{z}/{y}/{x}',
      { attribution: 'Labels &copy; Esri', maxZoom: 13 }
    );

    // Light map alternative
    const positron = L.tileLayer(
      'https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png',
      { attribution: '&copy; OpenStreetMap &copy; CartoDB', maxZoom: 20 }
    );

    L.control.layers(
      { 'Esri Imagery (realistic)': esriImg, 'Esri Ocean': esriOcean, 'CartoDB Positron': positron },
      { 'Ocean labels': oceanRef },
      { collapsed: true }
    ).addTo(map);

    // Bounds to cover the Arabian Sea fully (padded)
    const ARABIAN_BOUNDS = [[4, 43], [27, 80]];

    document.getElementById('btnArabian').onclick = () => map.fitBounds(ARABIAN_BOUNDS, { padding: [20, 20] });
    document.getElementById('btnWorld').onclick = () => map.setView([20, 0], 2);

    // Start focused on Arabian Sea
    map.fitBounds(ARABIAN_BOUNDS, { padding: [20, 20] });

    // ====== CATEGORIES (density scale) ======
    // Diverging palette often used for densities: low=deep blue, medium=yellow, high=red
    const categories = {
      'Very High': { color: '#d7191c', value: 5 },
      'High':      { color: '#fdae61', value: 4 },
      'Medium':    { color: '#ffffbf', value: 3 },
      'Low':       { color: '#abd9e9', value: 2 },
      'Very Low':  { color: '#2c7bb6', value: 1 }
    };

    // ====== DATES (2024) ======
    const issueDate = new Date('2024-09-29'); // set to 2024 as requested
    let currentDay = 0;
    const forecastDates = [];
    for (let i = 0; i < 7; i++) {
      const d = new Date(issueDate);
      d.setDate(d.getDate() + i + 2);
      forecastDates.push(d);
    }

    function weekdayName(d){
      return d.toLocaleDateString('en-US', { weekday: 'long' });
    }
    function ymd(d){
      return d.toISOString().split('T')[0];
    }

    // ====== DATA (synthetic density for demo) ======
    function generateAbundanceData(day) {
      const data = [];
      const gridSize = 0.25;
      for (let lat = 4; lat <= 27; lat += gridSize) {
        for (let lon = 43; lon <= 80; lon += gridSize) {
          // Smooth fields that drift over time to mimic fronts/upwelling
          const latWave = Math.sin((lat - 15) / 4 + day * 0.25);
          const lonWave = Math.cos((lon - 60) / 6 + day * 0.18);
          const mesoscale = Math.sin((lat + lon) / 10 + day * 0.12) * 0.3;
          const noise = (Math.sin(lat*3.1 + lon*2.7 + day) + 1) * 0.04; // deterministic small texture

          // Base field biased along shelf edge (approx 200–500 m contour band)
          const shelfBias = Math.exp(-Math.pow((lon - 64), 2) / 90) * Math.exp(-Math.pow((lat - 17), 2) / 60);

          const raw = 0.25*latWave + 0.25*lonWave + mesoscale + shelfBias + noise + 1.2;
          const value = Math.max(0, Math.min(1, raw / 2.5)); // clamp 0..1

          let category;
          if (value > 0.8) category = 'Very High';
          else if (value > 0.6) category = 'High';
          else if (value > 0.4) category = 'Medium';
          else if (value > 0.2) category = 'Low';
          else category = 'Very Low';

          data.push({
            bounds: [[lat, lon], [lat + gridSize, lon + gridSize]],
            category, value,
            lat: lat + gridSize / 2,
            lon: lon + gridSize / 2
          });
        }
      }
      return data;
    }

    function interpHex(c1,c2,t){
      const r1=parseInt(c1.substr(1,2),16), g1=parseInt(c1.substr(3,2),16), b1=parseInt(c1.substr(5,2),16);
      const r2=parseInt(c2.substr(1,2),16), g2=parseInt(c2.substr(3,2),16), b2=parseInt(c2.substr(5,2),16);
      const r=Math.round(r1+(r2-r1)*t), g=Math.round(g1+(g2-g1)*t), b=Math.round(b1+(b2-b1)*t);
      return '#' + ((1<<24)+(r<<16)+(g<<8)+b).toString(16).slice(1);
    }
    function interpolateColor(v){
      // Map 0..1 to blue -> lightblue -> yellow -> orange -> red
      if(v<=0.25){ return interpHex('#2c7bb6','#abd9e9', v/0.25); }
      if(v<=0.50){ return interpHex('#abd9e9','#ffffbf', (v-0.25)/0.25); }
      if(v<=0.75){ return interpHex('#ffffbf','#fdae61', (v-0.50)/0.25); }
      return interpHex('#fdae61','#d7191c', (v-0.75)/0.25);
    }

    const allData = Array.from({length:7},(_,i)=>generateAbundanceData(i));

    // ====== LAYERS ======
    let densityLayer = L.layerGroup().addTo(map);

    function renderDay(day){
      densityLayer.clearLayers();
      const data = allData[day];
      data.forEach(cell=>{
        const rect = L.rectangle(cell.bounds, {
          color: categories[cell.category].color,
          fillColor: interpolateColor(cell.value),
          fillOpacity: 0.45,
          weight: 0,
          interactive: true
        });
        rect.on('click', (e)=>{
          L.popup()
           .setLatLng(e.latlng)
           .setContent(`
            <h3>Fish Abundance Density (Demo)</h3>
            <div class="popup-row"><span class="popup-label">Forecast:</span> ${weekdayName(forecastDates[day])}, ${ymd(forecastDates[day])}</div>
            <div class="popup-row"><span class="popup-label">Category:</span> ${cell.category}</div>
            <div class="popup-row"><span class="popup-label">Issued:</span> ${weekdayName(issueDate)}, ${ymd(issueDate)}</div>
            <div class="popup-row"><span class="popup-label">Latitude:</span> ${cell.lat.toFixed(3)}</div>
            <div class="popup-row"><span class="popup-label">Longitude:</span> ${cell.lon.toFixed(3)}</div>
          `).openOn(map);
        });
        densityLayer.addLayer(rect);
      });
    }

    // ====== CONTOURS (stylized shelf/depth hints) ======
    const contourDepths = [50, 100, 200, 500, 1000];
    const contourLayer = L.layerGroup().addTo(map);

    function generateContourPath(depth){
      const pts = [];
      const base = Math.log(depth)*2;
      if (depth < 150){
        for (let lat=6; lat<=26; lat+=0.5){
          const lon = 50 + base + Math.sin(lat/3)*2;
          pts.push([lat, lon]);
        }
      } else if (depth < 600){
        for (let lat=5; lat<=27; lat+=0.5){
          const lon = 52 + base + Math.cos(lat/4)*3;
          pts.push([lat, lon]);
        }
      } else {
        for (let lat=4; lat<=27; lat+=0.5){
          const lon = 55 + base + Math.sin(lat/5)*4;
          pts.push([lat, lon]);
        }
      }
      return pts.filter(([la,lo]) => la>=4 && la<=27 && lo>=43 && lo<=80);
    }

    function addContours(){
      contourDepths.forEach(depth=>{
        const points = generateContourPath(depth);
        const polyline = L.polyline(points, { color:'#0ea5e9', weight:1.25, opacity:0.8 }).addTo(contourLayer);
        if (points.length>10){
          const mid = points[Math.floor(points.length/2)];
          L.marker(mid, { icon: L.divIcon({ className:'contour-label', html:`${depth}m`, iconSize:[40,20] }) }).addTo(contourLayer);
        }
      });
    }
    addContours();

    // ====== PORTS (context) ======
    const landingCentres = [
      { name: 'Mumbai', lat: 18.95, lon: 72.83 },
      { name: 'Kochi', lat: 9.97, lon: 76.28 },
      { name: 'Karachi', lat: 24.86, lon: 67.01 },
      { name: 'Muscat', lat: 23.61, lon: 58.54 },
      { name: 'Gwadar', lat: 25.12, lon: 62.33 },
      { name: 'Veraval', lat: 20.90, lon: 70.37 },
      { name: 'Mangalore', lat: 12.87, lon: 74.84 },
      { name: 'Porbandar', lat: 21.64, lon: 69.60 },
      { name: 'Calicut', lat: 11.25, lon: 75.77 },
      { name: 'Salalah', lat: 17.02, lon: 54.09 },
      { name: 'Dubai', lat: 25.20, lon: 55.27 }
    ];
    landingCentres.forEach(p=>{
      L.circleMarker([p.lat,p.lon], {
        radius:6, fillColor:'#0284c7', color:'#ffffff', weight:2, fillOpacity:0.95
      }).bindTooltip(p.name, { permanent:true, direction:'right', className:'port-label', offset:[8,0] }).addTo(map);
    });

    // ====== LEGEND ======
    const legend = L.control({ position:'bottomright' });
    legend.onAdd = function(){
      const div = L.DomUtil.create('div','legend');
      div.innerHTML = '<h4>Fish Abundance Density</h4>';
      Object.keys(categories).reverse().forEach(cat=>{
        div.innerHTML += `
          <div class="legend-item">
            <div class="legend-color" style="background-color:${categories[cat].color}"></div>
            <span>${cat}</span>
          </div>`;
      });
      return div;
    };
    legend.addTo(map);

    // ====== UI: weekday labels and dates ======
    function updateBanner(){
      const d = forecastDates[currentDay];
      document.getElementById('bannerForecastDate').textContent = `${weekdayName(d)}, ${ymd(d)}`;
      document.getElementById('bannerIssueDate').textContent = `${weekdayName(issueDate)}, ${ymd(issueDate)}`;
      document.getElementById('dateDisplay').textContent = `${weekdayName(d)} • ${ymd(d)}`;
    }

    renderDay(0);
    updateBanner();

    const slider = document.getElementById('timeSlider');
    slider.addEventListener('input', function(){
      currentDay = parseInt(this.value,10);
      renderDay(currentDay);
      updateBanner();
    });

    let animationInterval = null;
    const playBtn = document.getElementById('playBtn');
    const pauseBtn = document.getElementById('pauseBtn');

    playBtn.addEventListener('click', ()=>{
      playBtn.disabled = true; pauseBtn.disabled = false;
      animationInterval = setInterval(()=>{
        currentDay = (currentDay + 1) % 7;
        slider.value = currentDay;
        renderDay(currentDay);
        updateBanner();
      }, 1000);
    });

    pauseBtn.addEventListener('click', ()=>{
      playBtn.disabled = false; pauseBtn.disabled = true;
      clearInterval(animationInterval);
    });
  </script>
</body>
</html>
