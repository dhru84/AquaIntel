<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>AquaIntel ‚Äî Chatbot</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <link rel="stylesheet" href="styles.css">
  <style>
    html,body{background:linear-gradient(180deg,#0b1220,#0a152a)}
    .chat-shell{max-width:900px;margin:16px auto 120px;padding:0 16px}
    .chat-hero{background:linear-gradient(180deg,#0f172a,#0b1220);border:1px solid #1f2937;border-radius:16px;padding:18px;margin-bottom:16px}
    .chat-hero h1{margin:4px 0 6px;font-size:24px;color:#dbeafe}
    .sub{color:#93c5fd;font-size:14px}
    .chips{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    .chip{background:#0b1526;border:1px solid #1f2b45;color:#cbe1ff;border-radius:999px;padding:8px 12px;font-size:13px;cursor:pointer}
    .chip:hover{border-color:#38bdf8;color:#fff}

    .chat-box{background:linear-gradient(180deg,#0f172a,#0b1220);border:1px solid #1f2937;border-radius:16px;padding:0;overflow:visible} /* allow popover */
    .messages{max-height:520px;overflow:auto;padding:14px}
    .msg{display:flex;gap:10px;margin:10px 0}
    .msg .bubble{padding:10px 12px;border-radius:12px;border:1px solid #1f2937;max-width:78%}
    .me .bubble{background:#102038;color:#e5f0ff}
    .bot .bubble{background:#0b1526;color:#dbeafe}
    .bot .label{color:#93c5fd}
    .me .label{color:#94facc}
    .label{font-size:12px;margin-bottom:4px}

    .composer{display:flex;gap:10px;align-items:center;border-top:1px solid #1f2937;padding:10px;background:#0b1220;position:relative;overflow:visible}
    .composer-inner{display:flex;gap:10px;align-items:center; width:100%}
    .grow{flex:1; min-width:150px}

    .icon-btn{
      display:inline-flex; align-items:center; justify-content:center;
      width:42px; height:42px; border-radius:10px;
      border:1px solid #234; background:linear-gradient(180deg,#102038,#0d1a30);
      color:#e5f0ff; cursor:pointer;
    }
    .icon-btn:hover{border-color:#38bdf8;color:#fff}
    .send-btn{display:inline-flex; align-items:center; justify-content:center; width:46px; height:42px; border-radius:12px; border:1px solid #22314f; background:linear-gradient(180deg,#1a2235,#0f172a); color:#e5f0ff; cursor:pointer}
    .send-btn:hover{border-color:#3b82f6;color:#fff}

    .composer input[type="text"]{width:100%; background:#0b152a;border:1px solid #1f2b45;border-radius:12px;color:#dbeafe;padding:12px 14px;outline:none}
    .composer input[type="text"]:focus{border-color:#2563eb;box-shadow:0 0 0 3px #2563eb33}
    .upl{display:none}

    /* Floating portal popover (appended at body end) */
    #portal{position:fixed; left:0; top:0; width:0; height:0; z-index:10000; pointer-events:none}
    .models-pop{
      position:fixed; display:none; pointer-events:auto;
      background:linear-gradient(180deg,#0f172a,#0b1220);
      border:1px solid #1f2937; border-radius:12px; padding:10px; min-width:220px;
      box-shadow:0 10px 40px rgba(0,0,0,.45);
    }
    .models-pop h4{margin:0 0 8px; color:#dbeafe; font-size:14px}
    .models-pop ul{list-style:none; padding:0; margin:0; max-height:260px; overflow:auto}
    .models-pop li{padding:8px 10px; border-radius:8px; color:#cfe6ff; cursor:pointer}
    .models-pop li:hover{background:#0b1526; border:1px solid #1f2b45}

    .suggest{background:linear-gradient(180deg,#0f172a,#0b1220);border:1px solid #1f2937;border-radius:16px;padding:16px;margin-top:16px}
    .suggest h3{margin:0 0 8px;color:#dbeafe}
    .suggest ul{margin:8px 0 0 18px}
    .suggest li{margin:6px 0;color:#cbd5e1;cursor:pointer}
    .suggest li:hover{color:#fff}

    .qa{background:linear-gradient(180deg,#0f172a,#0b1220);border:1px solid #1f2937;border-radius:16px;padding:16px;margin-top:16px}
    .qa h3{margin:0 0 8px;color:#dbeafe}
    .qa-list{list-style:disc;margin:8px 0 0 18px}
    .qa-list li{margin:8px 0;color:#cbd5e1;cursor:pointer}
    .qa-list li:hover{color:#fff}

    .img-prev{margin-top:10px;border:1px dashed #27435e;border-radius:12px;overflow:hidden}
    .img-prev img{display:block;max-width:100%}
  </style>
</head>
<body>
  <div class="nav">
    <div class="nav-inner">
      <div class="brand"><div class="logo"></div><div class="name">AquaIntel</div></div>
      <div><a class="go" href="/">Home</a></div>
    </div>
  </div>

  <div class="chat-shell">
    <div class="chat-hero">
      <h1>Welcome to AquaIntel Chatbot</h1>
      <div class="sub">Ask ur queries ‚Äî choose a suggested question below or type in the box.</div>
      <div class="chips" id="chips"></div>
    </div>

    <div class="chat-box">
      <div class="messages" id="msgs"></div>

      <!-- Composer: input (left), tools on right [üß† üì∑ üé§ ‚¨ÜÔ∏è] -->
      <div class="composer">
        <div class="composer-inner">
          <div class="grow">
            <input id="inp" type="text" placeholder="Select a suggested question or type here (answers only for listed EEZ questions)">
          </div>

          <button id="modelBtn" class="icon-btn" title="Models">üß†</button>
          <label for="upl" class="icon-btn" title="Attach image">üì∑</label>
          <input id="upl" class="upl" type="file" accept="image/*">
          <button id="micBtn" class="icon-btn" title="Voice input">üé§</button>
          <button class="send-btn" id="send" title="Send">‚¨ÜÔ∏è</button>
        </div>
      </div>
    </div>

    <div class="suggest">
      <h3>Suggested questions</h3>
      <ul id="list"></ul>
    </div>

    <div class="qa">
      <h3>Fishing Q&A (Indian Coast)</h3>
      <ul class="qa-list" id="qaList"></ul>
    </div>
  </div>

  <!-- Floating portal (kept at body end to avoid clipping) -->
  <div id="portal">
    <div id="modelsPop" class="models-pop" role="menu" aria-label="Models">
      <h4>Models</h4>
      <ul id="modelsList"></ul>
    </div>
  </div>

<script>
/* EEZ questions + answers (unchanged) */
const allowedQs = [
  "What is an Exclusive Economic Zone (EEZ)?",
  "How far does a country‚Äôs EEZ extend from the coast?",
  "What is the difference between territorial sea and EEZ?",
  "What rights does a coastal state have in its EEZ?",
  "What is the contiguous zone and how wide is it?",
  "Does the EEZ include the right of innocent passage?",
  "What activities are allowed for foreign ships in an EEZ?",
  "What is the continental shelf and can it extend beyond 200 nm?",
  "How large is India‚Äôs EEZ approximately?",
  "Who defines the global rules for EEZs?",
  "What happens when two countries‚Äô EEZs overlap?",
  "Can a state restrict military activities in its EEZ?",
  "What is the difference between EEZ and high seas?",
  "How wide is the territorial sea limit for India?",
  "What is an extended continental shelf (ECS)?"
];

const answers = {
  "What is an Exclusive Economic Zone (EEZ)?":
    "An EEZ is a sea area beyond and adjacent to the territorial sea where a coastal State has sovereign rights to explore, exploit, conserve, and manage natural resources of the waters, seabed, and subsoil, along with certain jurisdictional rights.",
  "How far does a country‚Äôs EEZ extend from the coast?": "Up to 200 nautical miles from the baselines used to measure the territorial sea.",
  "What is the difference between territorial sea and EEZ?":
    "The territorial sea (up to 12 nautical miles) is under full sovereignty, subject to innocent passage; the EEZ (up to 200 nm) grants resource and certain jurisdictional rights, not full sovereignty over the waters.",
  "What rights does a coastal state have in its EEZ?":
    "Sovereign rights for resource exploration and exploitation (living and non‚Äëliving), and jurisdiction over artificial islands, marine scientific research, and environmental protection.",
  "What is the contiguous zone and how wide is it?":
    "A zone contiguous to the territorial sea where a State may enforce customs, fiscal, immigration, and sanitation laws; it may extend up to 24 nautical miles from the baseline.",
  "Does the EEZ include the right of innocent passage?":
    "Innocent passage applies to the territorial sea. In the EEZ, other States enjoy freedoms of navigation and overflight subject to the coastal State‚Äôs rights.",
  "What activities are allowed for foreign ships in an EEZ?":
    "Freedoms of navigation and overflight, laying cables and pipelines, and other internationally lawful uses consistent with these freedoms and with coastal State rights.",
  "What is the continental shelf and can it extend beyond 200 nm?":
    "It is the seabed and subsoil of submarine areas to the outer edge of the continental margin or 200 nm; it can extend beyond 200 nm where the natural margin warrants it, subject to scientific criteria.",
  "How large is India‚Äôs EEZ approximately?": "Often cited near 2.37 million square kilometers, considering mainland and island territories.",
  "Who defines the global rules for EEZs?": "The United Nations Convention on the Law of the Sea (UNCLOS) sets EEZ rules; States implement them via national laws and boundary agreements.",
  "What happens when two countries‚Äô EEZs overlap?":
    "They delimit boundaries by agreement based on international law, using equitable principles and relevant circumstances.",
  "Can a state restrict military activities in its EEZ?":
    "Practice varies; many States accept foreign military navigation and exercises if consistent with UNCLOS freedoms and without infringing coastal State rights.",
  "What is the difference between EEZ and high seas?":
    "The EEZ is a 200‚Äënm zone with coastal State resource rights; the high seas lie beyond national jurisdiction and are open to all States.",
  "How wide is the territorial sea limit for India?": "India‚Äôs territorial sea extends up to 12 nautical miles from the baseline under international and national law.",
  "What is an extended continental shelf (ECS)?":
    "The portion of the continental shelf beyond 200 nm where the continental margin extends naturally; outer limits are established using scientific criteria and procedures."
};

/* Fishing Q&A data */
const fishingQA = [
  { q:"Are the Vanjaram (Seer Fish) taking trolled lures or is everyone still using live sardines?",
    a:"They're mostly hitting live bait right now. The trollers are getting the smaller ones, but the big ones are only taking live sardines or mackerel fished deep, about 20 to 30 meters down, just before the tide turns." },
  { q:"What's the best time to cast for Bangda (Mackerel) from the jetty? Is the bite better at dawn or sunset?",
    a:"The bite has been strong just as the sun is coming up (dawn). They are feeding right on the surface. Use a small, shiny silver spoon or a sabiki rig to catch them when the water is choppy, that's where they hide." },
  { q:"Since the backwaters are muddy after the rain, will the Karimeen (Pearl Spot) be hiding deep, or should I fish near the mangrove roots?",
    a:"They will be tightly hugging the mangrove roots and submerged structures to get out of the dirty flow. Don't worry about depth; keep your bait right near the structure. Live shrimp or small prawn meat near the bottom works best when the water is murky." },
  { q:"Is the Paplet (Pomfret) movement restricted to the deeper water, or are they moving into the shallows yet this season?",
    a:"They've just started moving into the shallows this week, following the baitfish. Try drifting small pieces of squid or fish meat over a sandy bottom in about 10 meters of water. The silver variety is hitting particularly well." },
  { q:"Where are the schools of Mathi (Sardine) gathering? Are they close to the coast or far out?",
    a:"The schools are very close to the coast right now, in the first channel beyond the surf line. If you see a lot of gulls or pelicans diving, that's where the Netholi (Anchovy) are, and the larger fish will be underneath them." },
  { q:"I'm heading out on the West Coast. What's the better time for Rawas (Indian Salmon) fishing: early morning incoming tide or the slack tide mid-day?",
    a:"Always target the strong incoming tide in the morning. They feed aggressively as the water moves. Look for them around rocky patches where the bottom drops off, and use a heavy jig or live mullet as bait." },
  { q:"Is the big run of Ilish (Hilsa) fish over near the river mouth? What depth are they running at now?",
    a:"The main spawning run has slowed down, but you can still find stragglers. They are now holding slightly deeper in the estuary channel, usually around 6‚Äì8 meters. Use a fine nylon net if you're commercial fishing, as they are very sensitive." },
  { q:"The river water is high and murky. Will the Kaari (Catfish) be feeding actively, and what bait should I use for better success?",
    a:"Yes, Catfish love murky water! They use their barbels to find food in low visibility. Fish right on the muddy bottom with a strong scent bait like cut bait (small fish chunks) or a paste made from rice flour and oil." },
  { q:"How do I specifically target Naaku Meen (Sole Fish) when bottom fishing? Do I need a different rig than for Snapper?",
    a:"Sole are flatfish that bury themselves in the sand, so you need to present the bait right on the seabed. Use a rig with a long, thin leader and a small hook tipped with a piece of shrimp or clam. Drag it very slowly across the sandy/muddy bottom." },
  { q:"Are the Konju (Prawns) moving offshore in preparation for the breeding season, or are they still close to the coastal mud flats?",
    a:"They have started their migration, so the bigger catches are found where the coastal mudflats transition into deeper water. The commercial trawlers are finding good hauls in about 40‚Äì60 meters depth, mainly at night." }
];

/* Elements */
const chips = document.getElementById('chips');
const list  = document.getElementById('list');
const msgs  = document.getElementById('msgs');
const inp   = document.getElementById('inp');
const send  = document.getElementById('send');
const upl   = document.getElementById('upl');
const qaList= document.getElementById('qaList');
const micBtn= document.getElementById('micBtn');
const modelBtn = document.getElementById('modelBtn');
const modelsPop = document.getElementById('modelsPop');
const modelsList = document.getElementById('modelsList');

/* Populate models dropdown */
const MODELS = ["IIT Pune","IISc Bengaluru","NIOT Chennai","NIO Goa","CMFRI Kochi","INCOIS Hyderabad","IIT Madras","TERI"];
MODELS.forEach(m=>{
  const li = document.createElement('li');
  li.textContent = m;
  li.tabIndex = 0;
  li.onclick = ()=>{ addMsg('bot', `Model selected: ${m}`); hideModels(); };
  li.onkeydown = (e)=>{ if(e.key==='Enter'){ li.click(); } };
  modelsList.appendChild(li);
});

/* Show/hide models with precise viewport positioning */
function showModels() {
  const r = modelBtn.getBoundingClientRect();
  modelsPop.style.left = (r.left) + 'px';
  modelsPop.style.top  = (r.bottom + 8) + 'px';
  modelsPop.style.display = 'block';
}
function hideModels() {
  modelsPop.style.display = 'none';
}
modelBtn.addEventListener('click', (e)=>{
  e.stopPropagation();
  if(modelsPop.style.display==='block') hideModels(); else showModels();
});
document.addEventListener('click', (e)=>{
  if(modelsPop.style.display==='block' && !modelsPop.contains(e.target) && e.target!==modelBtn){
    hideModels();
  }
});

/* Helpers */
function addMsg(who, text, html=false){
  const div = document.createElement('div');
  div.className = 'msg ' + (who==='me' ? 'me':'bot');
  const b = document.createElement('div');
  b.className = 'bubble';
  const lab = document.createElement('div');
  lab.className = 'label';
  lab.textContent = (who==='me'?'You':'Aquainel Bot');
  b.appendChild(lab);
  const body = document.createElement('div');
  if(html) body.innerHTML = text; else body.textContent = text;
  b.appendChild(body);
  div.appendChild(b);
  msgs.appendChild(div);
  msgs.scrollTop = msgs.scrollHeight;
}

function botAnswer(q){
  if(answers[q]) return answers[q];
  return "Please select a question from the suggested list to get a precise, general EEZ answer.";
}

/* Chips + list */
allowedQs.slice(0,5).forEach(q=>{
  const c = document.createElement('button');
  c.className = 'chip';
  c.textContent = q;
  c.onclick = ()=>{ addMsg('me', q); addMsg('bot', botAnswer(q)); };
  chips.appendChild(c);
});
allowedQs.forEach(q=>{
  const li = document.createElement('li');
  li.textContent = q;
  li.onclick = ()=>{ addMsg('me', q); addMsg('bot', botAnswer(q)); };
  list.appendChild(li);
});

/* Send */
send.onclick = ()=>{
  const q = (inp.value||"").trim();
  if(!q) return;
  addMsg('me', q);
  const match = allowedQs.find(s => s.toLowerCase() === q.toLowerCase());
  if(match) addMsg('bot', botAnswer(match));
  else addMsg('bot', "Only the listed EEZ questions are supported right now. Pick one above.");
  inp.value = "";
};

/* Mic (voice) */
micBtn.onclick = ()=>{
  try{
    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    if(!SR){ alert("Voice input not supported in this browser."); return; }
    const rec = new SR();
    rec.lang = "en-IN";
    rec.interimResults = false;
    rec.maxAlternatives = 1;
    rec.onresult = (e)=>{ const t = e.results[0][0].transcript; inp.value = t; };
    rec.onerror = ()=>{};
    rec.start();
  }catch(e){
    alert("Voice input not available.");
  }
};

/* Camera preview */
upl.onchange = ()=>{
  const f = upl.files && upl.files[0];
  if(!f) return;
  const url = URL.createObjectURL(f);
  addMsg('me', "Uploaded an image:");
  addMsg('me', `<div class="img-prev"><img src="${url}" alt="uploaded image"></div>`, true);
  addMsg('bot', "Image received. The chatbot currently previews images; advanced analysis can be added later.");
};

/* Fishing Q&A */
fishingQA.forEach(item=>{
  const li = document.createElement('li');
  li.textContent = item.q;
  li.onclick = async ()=>{
    addMsg('me', item.q);
    try{
      const r = await fetch('/qa', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ question: item.q })
      });
      if(r.ok){
        const j = await r.json();
        if(j && j.answer){ addMsg('bot', j.answer); return; }
      }
      addMsg('bot', item.a);
    }catch{ addMsg('bot', item.a); }
  };
  qaList.appendChild(li);
});
</script>
</body>
</html>
